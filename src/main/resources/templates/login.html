<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Login</title>
    <style>
        body {
          font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
          max-width: 560px;
          margin: 40px auto;
        }
        input {
          display: block;
          width: 100%;
          padding: 8px;
          margin: 8px 0;
          box-sizing: border-box;
        }
        button {
          padding: 8px 12px;
          margin: 6px 4px 0 0;
        }
        #error, #twoError {
          color: #b50000;
          margin: 8px 0;
          min-height: 18px;
          white-space: pre-wrap;
          word-break: break-word;
        }
        #totpBox, #twoStepPrompt {
          display: none;
          border: 1px solid #eee;
          padding: 12px;
          margin-top: 12px;
          background: #fafafa;
        }
        .muted {
          color: #666;
          font-size: 0.9rem;
          margin-top: 6px;
        }
    </style>
</head>
<body>

<h2>Login</h2>
<div id="error"></div>

<form id="loginForm">
    <input id="username" placeholder="username or email" required />
    <input id="password" type="password" placeholder="password" required />

    <button id="loginBtn" type="submit">Login</button>
</form>

<div id="twoStepPrompt">
    <h3>Two-factor authentication</h3>
    <div id="twoError"></div>
    <input id="twoTotp" placeholder="6-digit code" />
    <button id="twoContinue">Continue</button>
    <button id="twoBack">Back</button>
    <div class="muted" id="attemptsInfo"></div>
</div>

<script>
    (() => {
      const loginForm = document.getElementById('loginForm');
      const username = document.getElementById('username');
      const password = document.getElementById('password');
      const loginBtn = document.getElementById('loginBtn');
      const error = document.getElementById('error');

      const twoStep = document.getElementById('twoStepPrompt');
      const twoTotp = document.getElementById('twoTotp');
      const twoContinue = document.getElementById('twoContinue');
      const twoBack = document.getElementById('twoBack');
      const twoError = document.getElementById('twoError');
      const attemptsInfo = document.getElementById('attemptsInfo');

      let attempts = 3;
      let pendingPayload = null;

      const clearErrors = () => {
        error.innerText = '';
        twoError.innerText = '';
      };

      const isHtml = (res, txt) => {
        const ct = (res.headers.get('content-type') || '').toLowerCase();
        return ct.includes('text/html') || txt.trim().startsWith('<');
      };

      const short = (txt) => {
        if (!txt) return 'Invalid credentials';
        txt = txt.replace(/<[^>]*>/g, '').trim();
        return txt.length > 200 ? txt.slice(0, 200) + 'â€¦' : txt;
      };

      async function api(url, body) {
        return fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
      }

      loginForm.addEventListener('submit', async e => {
        e.preventDefault();
        clearErrors();
        loginBtn.disabled = true;

        const payload = {
          usernameOrEmail: username.value,
          password: password.value
        };

        try {
          const res = await api('/auth/login', payload);
          const text = await res.text();

          // SUCCESS
          if (res.ok) {
            const data = JSON.parse(text);
            localStorage.setItem('token', data.token);
            location.href = '/home';
            return;
          }

          // ONLY trigger 2FA on exact signal
          if (res.status === 401 && text.trim() === 'TOTP_REQUIRED') {
            pendingPayload = payload;
            show2fa();
            return;
          }

          // Any HTML = bad credentials
          if (isHtml(res, text)) {
            error.innerText = 'Wrong username or password';
            return;
          }

          error.innerText = short(text);
        } catch {
          error.innerText = 'Request failed';
        } finally {
          loginBtn.disabled = false;
        }
      });

      twoContinue.addEventListener('click', async () => {
        clearErrors();
        if (!pendingPayload) return;

        const code = twoTotp.value.trim();
        if (!code) {
          twoError.innerText = 'Enter 2FA code';
          return;
        }

        try {
          const res = await api('/auth/login', { ...pendingPayload, totpCode: code });
          const text = await res.text();

          if (res.ok) {
            const data = JSON.parse(text);
            localStorage.setItem('token', data.token);
            location.href = '/home';
            return;
          }

          attempts--;
          if (attempts <= 0) {
            twoError.innerText = 'Too many attempts';
            setTimeout(reset, 800);
            return;
          }

          twoError.innerText = 'Invalid 2FA code';
          attemptsInfo.innerText = `Attempts left: ${attempts}`;
        } catch {
          twoError.innerText = 'Request failed';
        }
      });

      twoBack.addEventListener('click', reset);

      function show2fa() {
        loginForm.style.display = 'none';
        twoStep.style.display = 'block';
        attempts = 3;
        attemptsInfo.innerText = `Attempts left: ${attempts}`;
        twoTotp.value = '';
      }

      function reset() {
        pendingPayload = null;
        loginForm.style.display = 'block';
        twoStep.style.display = 'none';
        clearErrors();
      }
    })();
</script>
</body>
</html>
